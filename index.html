<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Um Chamado à Edificação</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <meta name="description" content="Um Chamado à Edificação - Cartas semanais para o despertar dos edificadores" />
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #f5f7fa;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
      }
      .loading-container {
        text-align: center;
        padding: 2rem;
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-width: 90%;
        width: 400px;
      }
      h1 {
        font-family: 'Merriweather', serif;
        color: #333;
        margin-bottom: 1rem;
      }
      .loading-text {
        color: #666;
        margin-bottom: 1.5rem;
      }
      .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 2s linear infinite;
        margin: 0 auto 1rem;
      }
      .button {
        background-color: #4a73e8;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.25rem;
        font-weight: 500;
        cursor: pointer;
        margin: 0.5rem;
        text-decoration: none;
        display: inline-block;
      }
      .button:hover {
        background-color: #3857b3;
      }
      .error-container {
        margin-top: 1rem;
        padding: 1rem;
        background-color: #fff8f8;
        border: 1px solid #ffdddd;
        border-radius: 0.25rem;
        color: #d32f2f;
        display: none;
      }
      .debug-info {
        font-size: 12px;
        color: #666;
        margin-top: 1rem;
        text-align: left;
        display: none;
        background-color: #f5f5f5;
        padding: 0.5rem;
        border-radius: 0.25rem;
        max-height: 150px;
        overflow-y: auto;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <div class="loading-container">
      <h1>Um Chamado à Edificação</h1>
      <div class="loading-spinner"></div>
      <p class="loading-text">Carregando aplicação...</p>
      <div id="error-container" class="error-container">
        <p>Não foi possível carregar a aplicação. Por favor, tente novamente.</p>
      </div>
      <div>
        <button onclick="window.location.reload()" class="button">Recarregar Página</button>
        <a href="/api/healthcheck" target="_blank" class="button">Verificar API</a>
        <button onclick="window.location.href='/'" class="button">Ir para Página Inicial</button>
      </div>
      <div id="debug-info" class="debug-info"></div>
    </div>

    <script>
      // Exibir debug info por padrão durante diagnósticos
      document.getElementById('debug-info').style.display = 'block';

      let attempts = 0;
      const maxAttempts = 5;
      const debugInfo = document.getElementById('debug-info');

      function addLog(message) {
        if (debugInfo) {
          const timestamp = new Date().toLocaleTimeString();
          debugInfo.innerHTML += `<div>[${timestamp}] ${message}</div>`;
          console.log(message);
        }
      }

      // Adicionar informações sobre a rota atual
      addLog(`URL atual: ${window.location.href}`);
      addLog(`Caminho: ${window.location.pathname}`);

      // Verificar se estamos sendo redirecionados para a API
      if (window.location.pathname.includes('/api/')) {
        addLog('⚠️ ALERTA: Você está em uma rota de API em vez da página inicial!');
        // Se estiver na rota da API, redirecionar para a página inicial após 3 segundos
        setTimeout(() => {
          window.location.href = '/';
          addLog('Redirecionando para a página inicial...');
        }, 3000);
      }

      function showDebug() {
        if (debugInfo) {
          debugInfo.style.display = 'block';
        }
      }

      // Adicionar botão de debug em produção com ctrl+shift+d
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.shiftKey && e.key === 'D') {
          showDebug();
        }
      });

      function showError(message) {
        const errorContainer = document.getElementById('error-container');
        if (errorContainer) {
          errorContainer.style.display = 'block';
          errorContainer.innerHTML = `<p>${message}</p>`;
        }
        addLog(`ERRO: ${message}`);
      }

      // Verificar a API antes de prosseguir
      addLog("Iniciando verificação da API...");

      fetch('/api/healthcheck')
        .then(response => {
          addLog(`API respondeu com status: ${response.status}`);
          return response.json();
        })
        .then(data => {
          addLog(`API Healthcheck: ${JSON.stringify(data)}`);
          if (data.status === 'ok') {
            addLog("API respondeu OK, verificando se devemos ir para a aplicação principal...");

            // Verificar se não estamos na landing page e redirecionar se necessário
            if (window.location.pathname.includes('/api/')) {
              addLog("Estamos em uma rota de API. Redirecionando para a aplicação principal...");
              window.location.href = '/';
              return;
            }

            checkAppAssets();
          } else {
            showError("A API está indisponível no momento.");
          }
        })
        .catch(error => {
          addLog(`Erro ao verificar API: ${error.message}`);
          showError("Não foi possível conectar à API. Tentando carregar os assets mesmo assim.");
          // Mesmo com erro na API, vamos tentar carregar os assets
          checkAppAssets();
        });

      function checkAppAssets() {
        // Melhoramos a lista de caminhos possíveis para abranger mais casos
        const possiblePaths = [
          '/assets/index.js',
          '/assets/index-*.js', // Para capturar arquivos com hash
          '/dist/assets/index.js',
          '/dist/assets/index-*.js',
          '/client/assets/index.js',
          '/client/dist/assets/index.js'
        ];

        addLog(`Verificando ${possiblePaths.length} possíveis caminhos para os assets...`);

        // Listar arquivos na pasta atual para debug
        addLog("Verificando ambiente da aplicação...");

        // Tentar encontrar scripts na página
        const listFiles = () => {
          fetch('/api/healthcheck')
            .then(response => {
              addLog(`Healthcheck re-verificação status: ${response.status}`);
              return response.text();
            })
            .then(text => {
              addLog(`Healthcheck resposta: ${text.substring(0, 50)}...`);
              return findAssetsWithWildcard();
            })
            .catch(err => {
              addLog(`Erro ao listar arquivos: ${err.message}`);
              findAssetsWithWildcard();
            });
        };

        // Nova abordagem para encontrar assets com suporte a wildcard
        function findAssetsWithWildcard() {
          addLog("Iniciando busca pela aplicação principal...");

          // Criar o contêiner root para a aplicação React
          const rootDiv = document.createElement('div');
          rootDiv.id = 'root';

          // Adicionar à página, mas manter a tela de carregamento visível por enquanto
          document.body.appendChild(rootDiv);

          // Caminhos específicos baseados na estrutura de projeto React/Vite
          const mainPaths = [
            '/dist/assets/index-*.js',
            '/assets/index-*.js',
            '/client/dist/assets/index-*.js',
            '/src/main.tsx'
          ];

          addLog("Tentando carregar o script principal da aplicação...");

          // Tentar carregar o script principal diretamente - baseado no client/index.html
          const script = document.createElement('script');
          script.type = 'module';
          script.src = '/src/main.tsx'; // Primeira tentativa com o caminho padrão

          script.onload = () => {
            addLog("✅ Script principal carregado com sucesso!");
            // Esconder a tela de carregamento após sucesso
            document.querySelector('.loading-container').style.display = 'none';
          };

          script.onerror = () => {
            addLog("❌ Não foi possível carregar o script principal. Tentando alternativas...");

            // Tentar carregar diretamente do client/
            const clientScript = document.createElement('script');
            clientScript.type = 'module';
            clientScript.src = '/client/src/main.tsx';

            clientScript.onload = () => {
              addLog("✅ Script do client/ carregado com sucesso!");
              document.querySelector('.loading-container').style.display = 'none';
            };

            clientScript.onerror = () => {
              addLog("❌ Falha ao carregar scripts alternativos. Tentando redirecionamento direto...");

              // Se nenhum script for carregado, redirecionar para a raiz explicitamente
              setTimeout(() => {
                // Se não conseguimos carregar os scripts, a última opção é redirecionar
                if (window.location.pathname !== '/') {
                  addLog("Redirecionando para a raiz...");
                  window.location.href = '/';
                } else {
                  // Se já estamos na raiz e ainda não funciona, mostrar mensagem de diagnóstico
                  showError("Não foi possível carregar a aplicação. Verifique o console para mais detalhes.");

                  // Verificar erros de console
                  if (console.error) {
                    const originalError = console.error;
                    console.error = function() {
                      addLog(`ERRO CONSOLE: ${Array.from(arguments).join(' ')}`);
                      originalError.apply(console, arguments);
                    };
                  }
                }
              }, 2000);
            };

            document.head.appendChild(clientScript);
          };

          document.head.appendChild(script);
        }

        // Inicia o processo de verificação
        listFiles();
      }

      function loadAppWithPath(path) {
        addLog(`Carregando aplicação com script: ${path}`);

        // Limpar o HTML atual
        document.body.innerHTML = '<div id="root"></div>';

        // Criar e adicionar o script
        const script = document.createElement('script');
        script.type = 'module';
        script.src = path;
        script.onload = () => addLog("Script carregado com sucesso!");
        script.onerror = (e) => {
          addLog(`Erro ao carregar script: ${e}`);
          showError("Erro ao carregar o script principal.");
          showDebug();
        };

        document.head.appendChild(script);
      }
    </script>
  </body>
</html>